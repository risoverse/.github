# .github/workflows/auto-team-assignment.yml
name: Auto Team Assignment

on:
  repository_created: # この行を変更
  workflow_dispatch:  # 手動実行用に追加

permissions:
  contents: read
  administration: write # リポジトリ管理権限を追加

jobs:
  assign-teams:
    runs-on: ubuntu-latest
    # デバッグ用に条件を緩和
    steps:
      - name: Debug Info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Organization: ${{ github.repository_owner }}"

      - name: Add teams to repository
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.ORG_ADMIN_TOKEN }}
          script: |
            const teamsConfig = [
              { 
                name: 'InternalTeam',
                permission: 'push'
              },
              { 
                name: 'SpecificTeam',
                permission: 'pull'
              }
            ];
            
            try {
              console.log('Starting team assignment process...');
              
              for (const team of teamsConfig) {
                console.log(`Processing team: ${team.name}`);
                
                await github.rest.teams.addOrUpdateRepoPermissionsInOrg({
                  org: context.repo.owner,
                  team_slug: team.name,
                  owner: context.repo.owner,
                  repo: context.repo.name,
                  permission: team.permission
                });
                
                console.log(`Successfully added ${team.name} to ${context.repo.name}`);
              }
            } catch (error) {
              console.error('Error occurred:', error.message);
              core.setFailed(error.message);
            }